---
title: "Analysis of Lifetime Commissions By Agent"
output: word_document
---

The data used in this document comes from the AmeriLife data warehouse and the results are compiled from a live
extract from the cubes. The data is, thus, accurate up to the previous night's processing.

```{r, echo = FALSE}
# Load the Data and the required libraries

# Common libraries
library(ggplot2)
library(car)
library(dplyr)
library(corrplot)
library(gplots)
library(gridExtra)
library(cowplot)

# load the data form SQL Server
sConnection <- "Driver=SQL Server;Server=FL-TPA-BI-01.alg.local;Database=Amerilife_STG;Trusted_Connection=TRUE"
sqlTableName <- "staging.SSAS_Discovery_Recoded"

# Summarize the data by Agent 
sQuery <- "
SELECT  [pk] = MIN([pk])
,[Agent] = MIN([Agent])
,[NPN]
,[CRMGender] = MIN([CRMGender])
,[CRMCounty] = MIN([CRMCounty])
,[CRMState] = MIN([CRMState])
,[CRMZipCode] = MIN([CRMZipCode])
,[HasKits] = MAX([HasKits])
,[HasContracts] = MAX([HasContracts])
,[IsDirectContract] = max(isDirectContract)
,[HasCommissionPayments] = MAX([HasCommissionPayments])
,[DSCPrimaryAddressType] = MIN([DSCPrimaryAddressType])
,[DSCPrimaryCounty] = MIN([DSCPrimaryCounty])
,[DSCPrimaryMetropolitanArea] = MIN([DSCPrimaryMetropolitanArea])
,[DSCPrimaryZipCode] = MIN([DSCPrimaryZipCode])
,[DSCPrimaryZipCode3DigitSectional] = MIN([DSCPrimaryZipCode3DigitSectional])
,[DSCDateOfBirthYear] = MIN([DSCDateOfBirthYear])
,[DSCGenderCode] = MIN([DSCGenderCode])
,[DSCAgentLicenseTypeHealth] = MIN([DSCAgentLicenseTypeHealth])
,[DSCAgentLicenseTypeLife] = MIN([DSCAgentLicenseTypeLife])
,[DSCAgentLicenseTypeVariableProducts] = MIN([DSCAgentLicenseTypeVariableProducts])
,[DSCAgentLicenseTypePropertyCasualty] = MIN([DSCAgentLicenseTypePropertyCasualty])
,[DSCNumberStateLicensesHealth] = MIN([DSCNumberStateLicensesHealth])
,[DSCNumberStateLicensesLife] = MIN([DSCNumberStateLicensesLife])
,[DSCNumberStateLicensesVariableProducts] = MIN([DSCNumberStateLicensesVariableProducts])
,[DSCNumberStateLicensesPropertyCasualty] = MIN([DSCNumberStateLicensesPropertyCasualty])
,[DSCStateLicensedCount] = MIN([DSCStateLicensedCount])
,[DSCSellsRetirementPlanProducts] = MIN([DSCSellsRetirementPlanProducts])
,[DSCCarrierAppointments] = MIN([DSCCarrierAppointments])
,[DSCAppointmentCount] = MIN([DSCAppointmentCount])
,[DSCYearsOfExperience] = MIN([DSCYearsOfExperience])
,[DSCEarliestAppointmentDate] = MIN([DSCEarliestAppointmentDate])
,[DSCDuallyLicensed] = MIN([DSCDuallyLicensed])
,[DSCInCRD] = MIN([DSCInCRD])
,[DSCRIAAffiliation] = MIN([DSCRIAAffiliation])
,[DSCBDRIARep] = MIN([DSCBDRIARep])
,[DSCBrokerDealerAffiliation] = MIN([DSCBrokerDealerAffiliation])
,[12MonthRevenueFromContractCompleted] = SUM([12MonthRevenueFromContractCompleted])
,[12MonthRevenueFromContractEffective] = SUM([12MonthRevenueFromContractEffective])
,[12MonthFromFirstRevenue] = SUM([12MonthFromFirstRevenue])
,[24MonthRevenueFromContractCompleted] = SUM([24MonthRevenueFromContractCompleted])
,[24MonthRevenueFromContractEffective] = SUM([24MonthRevenueFromContractEffective])
,[24MonthFromFirstRevenue] = SUM([24MonthFromFirstRevenue])
,[RevenueSinceInception] = SUM([RevenueSinceInception])
,[PolicyCount] = SUM([PolicyCount])
,[Payments] = SUM([Payments])
,[Commission] = SUM([Commission])
,[PaymentCountSinceInception] = SUM([PaymentCountSinceInception])
,RecordCount = COUNT(*)
FROM [staging].[SSAS_Discovery_Recoded]
group by NPN
"

sqlDataTable <- RxSqlServerData(connectionString = sConnection,
    sqlQuery = sQuery)
    #table = sqlTableName)
df <- rxImport(inData = sqlDataTable,
    rowsPerRead = 10000,
    stringsAsFactors = TRUE)



# Set the row names to the pk from SQL
row.names(df) <- df$pk 
```

To begin the analysis we will look at the data graphically. We will start with a global summary and drill down into detail following the 
indications that the data provides. We start with the distribution of lifetime commissions to AmeriLife from all agents;
this distribution is derived from the history accumulated in the data warehouse, which starts in the 2013 - 2014 years. 
The distribution looks as follows:

```{r, echo = FALSE}
# All
dfPlot <- df %>%
select(Commission)
ggplot(data = dfPlot, aes(x = Commission, y = ..density..)) +
geom_histogram(binwidth = 1000, color = "grey60", size = 0.2) +
geom_density(color = "red", size = 1) +
ggtitle("Frequency of Lifetime Commissions generated by an Agent") +
labs(x = "Total Commissions", y = "Frequency") 
```

The Commissions range from a low (debt) of about $28,000 to a positive contribution of just over $220,000; the distribution of lifetime agent commisisons
is heavily skewed, with a large contingen of agents that either do not contribute revenue to AmeriLife or are a debt burden
to the organization. The basic statistics of this distribution are:

```{r}
# Commissions
summary(df$Commission) 
```

A manually binned histogram of those commissions by range of revenue looks as follows:

```{r, echo = FALSE}
CommissionBinned <-
recode(df$Commission, "-30000:-5000='Debt 5 to 30k';-4999.99:-500='Debt 500 to 5k';
    -499.99:0='Small Debt';0.01:100='$0 to $100'; 100.01:200='$100 to $200';
    200.01:300='$200 to $300';300.01:400='$300 to $400';400.01:500='$400 to $500';
    500.01:1000 = '$500 to $1k';1000.01:5000 = '$1k to $5k';else = 'Above $5k' ",
    as.factor.result = TRUE,
    levels = c('Debt 5 to 30k', 'Debt 500 to 5k', 'Small Debt', '$0 to $100', '$100 to $200',
    '$200 to $300', '$300 to $400', '$400 to $500', '$500 to $1k', '$1k to $5k', 'Above $5k'))
dfBinned <- data.frame(table(CommissionBinned))
#barplot(table(CommissionBinned))
ggplot(data = dfBinned, aes(x = CommissionBinned, y = Freq)) +
geom_bar(stat = "identity") +
ylim(0, 45000) +
ggtitle("Commissions and Debt\ngenerated by an Agent") +
labs(x = "Total Commissions", y = "Count of Agents") +
theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
geom_text(aes(label = Freq), vjust = -0.2, color = "darkgreen", size = 3) 
```

In tabular form:

```{r, echo = FALSE}
dfBinned 
```

Given that enrolling an agent to sell for AmeriLife carries an initial estimated cost of $400, it behooves us to find out what are the attributes of 
agents that are capable of generating more that that amount in revenue through their lifetime.

Before leaving the analysis of lifetime commissions it is worth noting that at every level of revenue, there appears to be
a larger number of direct agents vs. downline agents achieving that revenue. Here are some examples:

```{r, echo = FALSE}
# Between $500 and $2,500 - Counts - Stacked by Direct vs Upline
dfPlot <- df %>%
select(c(Commission, IsDirectContract)) %>%
filter(Commission <= 2500 & Commission >= 500)
p1 <- ggplot(data = dfPlot, aes(x = Commission, y = ..count.., fill = IsDirectContract)) +
geom_histogram(binwidth = 100, color = "grey60", size = 0.2) +
ggtitle("Commissions from $500 up to $2,500\n generated by an Agent") +
labs(x = "Total Commissions", y = "Count of Agents")

# Between $2500 and $5,000 - Counts - Stacked by Direct vs Upline
dfPlot <- df %>%
select(c(Commission, IsDirectContract)) %>%
filter(Commission <= 5000 & Commission >= 2500)
p2 <- ggplot(data = dfPlot, aes(x = Commission, y = ..count.., fill = IsDirectContract)) +
geom_histogram(binwidth = 100, color = "grey60", size = 0.2) +
ggtitle("Commissions from $2,500 up to $5,000\n generated by an Agent") +
labs(x = "Total Commissions", y = "Count of Agents")

# Between $5000 and $50000 - Counts - Stacked by Direct vs Upline
dfPlot <- df %>%
select(c(Commission, IsDirectContract)) %>%
filter(Commission > 5000 & Commission <= 50000)
p3 <- ggplot(data = dfPlot, aes(x = Commission, y = ..count.., fill = IsDirectContract)) +
geom_histogram(binwidth = 5000, color = "grey60", size = 0.2) +
ggtitle("Commissions from $5000 to $50,000\n generated by an Agent") +
labs(x = "Total Commissions", y = "Count of Agents")

# Above $50000 - Counts - Stacked by Direct vs Upline
dfPlot <- df %>%
select(c(Commission, IsDirectContract)) %>%
filter(Commission > 50000)
p4 <- ggplot(data = dfPlot, aes(x = Commission, y = ..count.., fill = IsDirectContract)) +
geom_histogram(binwidth = 10000, color = "grey60", size = 0.2) +
ggtitle("Commissions above $50,000\n generated by an Agent") +
labs(x = "Total Commissions", y = "Count of Agents") 
#+geom_text(aes(label = "Count od Agents"), vjust = -0.2, color = "darkgreen", size = 3)
```

```{r, echo = FALSE}
p1
```

In this range of revenue generation, the proportion of direct vs. downline contracts is mor even than in any other range.

```{r, echo = FALSE}
p2
```

As revenue begins to increase, the proportion of direct agents generating the revenue increases with respect tot he 
downline agents generating the same volume of revenue.

```{r, echo = FALSE}
p3
```

```{r, echo = FALSE}
p4 
#+theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1), plot.margin = unit(c(0, 0, 0, 0), "cm"))
#grid.arrange(p1, p2, p3,p4, ncol = 1, nrow = 4)
#plot_grid(p1, p2, p3, p4, ncol = 1, nrow = 4)
```
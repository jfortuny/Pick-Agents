---
title: "Analysis of Commissions By Agent"
output: html_document
---

The data used in this document comes from the AmeriLife data warehouse and the results are compiled from a live
extract from the cubes. The data is, thus, accurate up to the previous night's processing.

```{r, echo = FALSE}
# Load the Data and the required libraries
# Read data only from Amerilife_STG; mostly done for single variable analysis.
source("~/visual studio 2015/projects/Pick Agents/Pick Agents/code/sourceAmerilife_STG.R", encoding = "Windows-1252")
```

Generally speaking, the commissions that an Agent generates for AmeriLife will be a function of:

* Agent attributes and abilities.
* Size and Growth of prospective insured population in the Agent's territory of operation.
* Products and Rates of Products the Agent sells and those of the competition.
* Support the Agent receives from AmeriLife and affiliated companies.
* Other/Unknown sources.

In this doucment we will start our analysis by focusing on the Agent attributes that make a difference 
in the Agent's impact on revenue generated for AmeriLife and start considering only the function: 
_Revenue = f(Agent)_. As we go along we will add other descriptors to the function: 
_Revenue = f(Agent, Population)_ in particular. 


# Lifetime Commissions

To begin the analysis we will look at the data graphically. We will start with a global summary and drill down into detail following the 
indications that the data provides. We start with the distribution of lifetime commissions to AmeriLife from all agents;
this distribution is derived from the history accumulated in the data warehouse, which starts in the 2013 - 2014 years. 
The distribution looks as follows:

```{r, echo = FALSE}
# All
dfPlot <- df %>%
select(Commission)
ggplot(data = dfPlot, aes(x = Commission, y = ..density..)) +
geom_histogram(binwidth = 1000, color = "grey60", size = 0.2) +
geom_density(color = "red", size = 1) +
ggtitle("Frequency of Lifetime Commissions generated by an Agent") +
labs(x = "Total Commissions", y = "Frequency") 
```

The Commissions range from a low (debt) of about $28,000 to a positive contribution of just over $220,000; the distribution of lifetime agent commisisons
is heavily skewed, with a large contingen of agents that either do not contribute revenue to AmeriLife or are a debt burden
to the organization. The basic statistics of this distribution are:

```{r, echo = FALSE}
# Commissions
summary(df$Commission) 
```

A manually binned histogram of those commissions by range of revenue looks as follows:

```{r, echo = FALSE}
CommissionBinned <-
recode(df$Commission, "-30000:-5000='Debt 5 to 30k';-4999.99:-500='Debt 500 to 5k';
    -499.99:0='Small Debt';0.01:100='$0 to $100'; 100.01:200='$100 to $200';
    200.01:300='$200 to $300';300.01:400='$300 to $400';400.01:500='$400 to $500';
    500.01:1000 = '$500 to $1k';1000.01:5000 = '$1k to $5k';else = 'Above $5k' ",
    as.factor.result = TRUE,
    levels = c('Debt 5 to 30k', 'Debt 500 to 5k', 'Small Debt', '$0 to $100', '$100 to $200',
    '$200 to $300', '$300 to $400', '$400 to $500', '$500 to $1k', '$1k to $5k', 'Above $5k'))
dfBinned <- data.frame(table(CommissionBinned))
#barplot(table(CommissionBinned))
ggplot(data = dfBinned, aes(x = CommissionBinned, y = Freq)) +
geom_bar(stat = "identity") +
ylim(0, 45000) +
ggtitle("Commissions and Debt\ngenerated by an Agent") +
labs(x = "Total Commissions", y = "Count of Agents") +
theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
geom_text(aes(label = Freq), vjust = -0.2, color = "darkgreen", size = 3) 
```

In tabular form:

```{r, echo = FALSE, results = 'asis'}
kable(dfBinned)
```

Given that enrolling an agent to sell for AmeriLife carries an initial estimated cost of $400, it behooves us to find out what are the attributes of 
agents that are capable of generating more that that amount in revenue through their lifetime.

### By Type of Agent: Direct vs. Downline Agents

Before leaving the analysis of lifetime commissions it is worth noting that at every level of revenue, there appears to be
a larger number of direct agents vs. downline agents achieving that revenue. Here are some examples:

```{r, echo = FALSE}
# Between $500 and $2,500 - Counts - Stacked by Direct vs Upline
dfPlot <- df %>%
select(c(Commission, IsDirectContract)) %>%
filter(Commission <= 2500 & Commission >= 500)
p1 <- ggplot(data = dfPlot, aes(x = Commission, y = ..count.., fill = IsDirectContract)) +
geom_histogram(binwidth = 100, color = "grey60", size = 0.2) +
ggtitle("Commissions from $500 up to $2,500\n generated by an Agent") +
labs(x = "Total Commissions", y = "Count of Agents") +
theme(legend.position = "top")
# Between $2500 and $5,000 - Counts - Stacked by Direct vs Upline
dfPlot <- df %>%
select(c(Commission, IsDirectContract)) %>%
filter(Commission <= 5000 & Commission >= 2500)
p2 <- ggplot(data = dfPlot, aes(x = Commission, y = ..count.., fill = IsDirectContract)) +
geom_histogram(binwidth = 100, color = "grey60", size = 0.2) +
ggtitle("Commissions from $2,500 up to $5,000\n generated by an Agent") +
labs(x = "Total Commissions", y = "Count of Agents") +
theme(legend.position = "top")

# Between $5000 and $50000 - Counts - Stacked by Direct vs Upline
dfPlot <- df %>%
select(c(Commission, IsDirectContract)) %>%
filter(Commission > 5000 & Commission <= 50000)
p3 <- ggplot(data = dfPlot, aes(x = Commission, y = ..count.., fill = IsDirectContract)) +
geom_histogram(binwidth = 5000, color = "grey60", size = 0.2) +
ggtitle("Commissions from $5,000 to $50,000\n generated by an Agent") +
labs(x = "Total Commissions", y = "Count of Agents") +
theme(legend.position = "top")

# Above $50000 - Counts - Stacked by Direct vs Upline
dfPlot <- df %>%
select(c(Commission, IsDirectContract)) %>%
filter(Commission > 50000)
p4 <- ggplot(data = dfPlot, aes(x = Commission, y = ..count.., fill = IsDirectContract)) +
geom_histogram(binwidth = 10000, color = "grey60", size = 0.2) +
ggtitle("Commissions above $50,000\n generated by an Agent") +
labs(x = "Total Commissions", y = "Count of Agents")  +
theme(legend.position = "top")
#+geom_text(aes(label = "Count od Agents"), vjust = -0.2, color = "darkgreen", size = 3)
```

```{r, echo = FALSE}
p1
```

In this range of revenue generation, the proportion of direct vs. downline contracts is mor even than in any other range.

```{r, echo = FALSE}
p2
```

As revenue begins to increase, the proportion of direct agents generating the revenue increases with respect tot he 
downline agents generating the same volume of revenue.

```{r, echo = FALSE}
p3
```

```{r, echo = FALSE}
p4 
#+theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1), plot.margin = unit(c(0, 0, 0, 0), "cm"))
#grid.arrange(p1, p2, p3,p4, ncol = 1, nrow = 4)
#plot_grid(p1, p2, p3, p4, ncol = 1, nrow = 4)
```

# Commissions Generated by an Agent in the first 12 months from Contract Completed

Does the Agent's ability to generate revenue for AmeriLife happen shortly after the Agent is Contracted or does it take
a long time? In this section we present the same graphs that were developed above for Lifetime Commissions but focus 
exclusively on the Commissions that an Agent generates thorugh a contract during the first 12 
months from the Contract Completed date. 

There is one caveat to this analysis: We do not eliminate any contracts from the analysis even if the contract has not 
accumulated 12 months of revenue from its contract completed date. Since there is a large population of contracts it's
expected that these contracts under 12 months old will not unduly influence the analysis.

```{r, echo = FALSE}
# All
dfPlot <- df %>%
select(`12MonthRevenueFromContractCompleted`)
ggplot(data = dfPlot, aes(x = `12MonthRevenueFromContractCompleted`, y = ..density..)) +
geom_histogram(binwidth = 1000, color = "grey60", size = 0.2) +
geom_density(color = "red", size = 1) +
ggtitle("Frequency of First 12 Month Commissions From CC\ngenerated by an Agent") +
labs(x = "First 12 Month Revenue From CC", y = "Frequency")
```

The Commissions range form a low (debt) of $6,500 to a high of just over $212,000; this distribution of values is 
also heavily skewed as was the distribution of lifetime commissions. The basis statistics of this distribution are:

```{r, echo = FALSE}
# First Year Commissions (from Contrct Completed)
summary(df$`12MonthRevenueFromContractCompleted`)
```

Since the range of values for the commissions generated in the first 12 months of an Agent's tenure in a contract
is almost exactly the same as that of the commissions that the Agent has generated in their lifetime, we bin the
data using the same buckets used in the previous section. The histogram of Commissions generated during the first 12 months 
in a contract's life follows (nothe the scale of the y axis is different than that of the lifetime commissions): 

```{r, echo = FALSE}
CommissionBinned <-
recode(df$`12MonthRevenueFromContractCompleted`, "-30000:-5000='Debt 5 to 30k';-4999.99:-500='Debt 500 to 5k';
    -499.99:0='Small Debt';0.01:100='$0 to $100'; 100.01:200='$100 to $200';
    200.01:300='$200 to $300';300.01:400='$300 to $400';400.01:500='$400 to $500';
    500.01:1000 = '$500 to $1k';1000.01:5000 = '$1k to $5k';else = 'Above $5k' ",
    as.factor.result = TRUE,
    levels = c('Debt 5 to 30k', 'Debt 500 to 5k', 'Small Debt', '$0 to $100', '$100 to $200',
    '$200 to $300', '$300 to $400', '$400 to $500', '$500 to $1k', '$1k to $5k', 'Above $5k'))
dfBinned <- data.frame(table(CommissionBinned))
#barplot(table(CommissionBinned))
ggplot(data = dfBinned, aes(x = CommissionBinned, y = Freq)) +
geom_bar(stat = "identity") +
ylim(0, 10000) +
ggtitle("Frequency of First 12 Month Commissions and Debt\ngenerated by an Agent") +
labs(x = "First 12 Month Commissions", y = "Count of Agents") +
theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
geom_text(aes(label = Freq), vjust = -0.2, color = "darkgreen", size = 3)
```

In tabular form:

```{r, echo = FALSE, results = 'asis'}
kable(dfBinned)
```

### By Type of Agent: Direct vs. Downline Agents

The pattern of revenue generation in the first 12 months of a contract's life resembles closely the
pattern of lifetime revenue. Here are some examples using the same binning and scales as the graphs
for lifetime commissions:

```{r, echo = FALSE}
# Between $500 and $2,500 - Counts - Stacked by Direct vs Upline
dfPlot <- df %>%
select(c(`12MonthRevenueFromContractCompleted`, IsDirectContract)) %>%
filter(`12MonthRevenueFromContractCompleted` <= 2500 & `12MonthRevenueFromContractCompleted` >= 500)
fy1 <- ggplot(data = dfPlot, aes(x = `12MonthRevenueFromContractCompleted`, y = ..count.., fill = IsDirectContract)) +
geom_histogram(binwidth = 100, color = "grey60", size = 0.2) +
ggtitle("First 12 Month Revenue From CC between $500 and $2,500\n generated by an Agent") +
labs(x = "First 12 Month Revenue From Contract Completed", y = "Count of Agents") +
theme(legend.position = "top")

# Between $2,500 and $5,000 - Counts - Stacked by Direct vs Upline
dfPlot <- df %>%
select(c(`12MonthRevenueFromContractCompleted`, IsDirectContract)) %>%
filter(`12MonthRevenueFromContractCompleted` > 2500 & `12MonthRevenueFromContractCompleted` <= 5000)
fy2 <- ggplot(data = dfPlot, aes(x = `12MonthRevenueFromContractCompleted`, y = ..count.., fill = IsDirectContract)) +
geom_histogram(binwidth = 100, color = "grey60", size = 0.2) +
ggtitle("First 12 Month Revenue From CC between $2,500 and $5,000\n generated by an Agent") +
labs(x = "First 12 Month Revenue From Contract Completed", y = "Count of Agents") +
theme(legend.position = "top")

# Between $5000 and $50000 - Counts - Stacked by Direct vs Upline
dfPlot <- df %>%
select(c(`12MonthRevenueFromContractCompleted`, IsDirectContract)) %>%
filter(`12MonthRevenueFromContractCompleted` > 5000 & `12MonthRevenueFromContractCompleted` <= 50000)
fy3 <- ggplot(data = dfPlot, aes(x = `12MonthRevenueFromContractCompleted`, y = ..count.., fill = IsDirectContract)) +
geom_histogram(binwidth = 5000, color = "grey60", size = 0.2) +
ggtitle("First 12 Month Revenue From CC between $5,000 and $50,000\n generated by an Agent") +
labs(x = "First 12 Month Revenue From Contract Completed", y = "Count of Agents") +
theme(legend.position = "top")

# Above $50,000
dfPlot <- df %>%
select(`12MonthRevenueFromContractCompleted`, IsDirectContract) %>%
filter(`12MonthRevenueFromContractCompleted` > 50000)
fy4 <- ggplot(data = dfPlot, aes(x = `12MonthRevenueFromContractCompleted`, y = ..count.., fill = IsDirectContract)) +
geom_histogram(binwidth = 5000, color = "grey60", size = 0.2) +
#geom_density(color = "red", size = 1) +
ggtitle("First 12 Month Revenue From CC of $50,000 and up\ngenerated by an Agent") +
labs(x = "First 12 Month Revenue From Contract Completed", y = "Count of Agents") +
theme(legend.position = "top")
```

```{r, echo = FALSE}
fy1
fy2
fy3
fy4

grid.arrange(p1, fy1, ncol = 2, nrow = 1)

```


# Appendix A: The highest producers

This is a list of the agents that have generated revenue for AmeriLife in excess of $5,000 during their lifetime, ordered by the revenue generated.

```{r, echo = FALSE, results = 'as is'}
topAgents <- df %>% 
select(c(Agent, NPN, CRMGender, CRMState, CRMZipCode, Commission, PolicyCount)) %>% 
filter(Commission >= 5000) %>%
arrange(Commission)
kable(topAgents)
```